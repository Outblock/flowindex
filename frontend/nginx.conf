server {
    listen 8080;
    server_name localhost;

    # Streaming SSR responses (React) should not be buffered by the proxy.
    proxy_buffering off;
    proxy_request_buffering off;

    # Dynamic DNS Resolution (Fixes stale backend IP on redeploy)
    # Using ${DNS_RESOLVER} populated by entrypoint.sh from /etc/resolv.conf
    resolver ${DNS_RESOLVER} valid=10s ipv6=off;
    set $backend_api "${BACKEND_API}";
    set $ssr_upstream "http://127.0.0.1:3000";

    # Normalize API base to always have trailing slash.
    location = /api {
        return 301 /api/;
    }

    # Fast health endpoint for LB checks (bypass SSR/app loaders).
    location = /health {
        default_type text/plain;
        return 200 "ok\n";
    }

    # Friendly API landing page (v2 as the default).
    location = /api/ {
        rewrite ^/api/$ /openapi/v2.json break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # OpenAPI (served by backend; keeps docs fresh). Default to v2.
    location = /api/openapi.json {
        rewrite ^/api/openapi.json$ /openapi/v2.json break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location = /api/openapi/v2.json {
        rewrite ^/api/openapi/v2.json$ /openapi/v2.json break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    # v1 spec is still available if someone knows the path, but we don't link to it.
    location = /api/openapi/v1.json {
        rewrite ^/api/openapi/v1.json$ /openapi/v1.json break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Explicit versioned API (pass-through)
    location /api/v2/ {
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /api/v1/ {
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Versioned API routes â€” strip /v1/ and forward to backend.
    # SDK generates URLs like /api/flow/v1/account/... but backend has /flow/account/...
    location ~ ^/api/(flow|accounting|status|defi|staking)/v1/(.*)$ {
        rewrite ^/api/(flow|accounting|status|defi|staking)/v1/(.*)$ /$1/$2 break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Legacy endpoints used by the UI (/blocks, /transactions, /accounts, /stats, /status, ...)
    # Strip the /api prefix and forward to backend root.
    location /api/ {
        rewrite ^/api/?(.*)$ /$1 break;
        proxy_pass $backend_api;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # WebSocket Proxy
    location /ws {
        # Need separate variable or same one, doesn't matter much as long as it's dynamic
        set $backend_ws "${BACKEND_WS}";
        proxy_pass $backend_ws;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
        proxy_set_header Host $host;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # App SSR (everything else)
    location / {
        proxy_pass $ssr_upstream;

        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Port $server_port;
    }
}
