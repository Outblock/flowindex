# FlowScan API Redesign Plan (v1 find‑api + v2 api.json)

## Summary
- **v1**: full compatibility with `find-api.json` (field-for-field, pagination allowed to vary).
- **v2**: strictly aligned to `api.json`.
- **Two OpenAPI specs + two Scalar docs** (separate pages).
- **API queries read only app DB**. raw DB is source-of-truth for workers.
- **Every endpoint has a unit test** (v1 + v2 separate).

## Scope
- v1 implements all endpoints from `find-api.json`.
- v2 implements all endpoints from `api.json` (subset of v1 paths).
- Non-overlapping endpoints remain v1-only (auth/public/simple/trigger/etc.).

## Data Architecture Principles
- raw tables are **write-only** for ingestion.
- app tables are **read-only** for APIs.
- workers translate raw → app with checkpoints & idempotency.
- API latency must not depend on raw scans.

## DB Model (app) — Required Coverage
Existing or planned app tables needed to satisfy v1 + v2:
- `app.address_transactions`
- `app.address_stats`
- `app.account_keys`
- `app.smart_contracts`
- `app.token_transfers`
- `app.ft_holdings`
- `app.nft_ownership`
- `app.tx_contracts`
- `app.tx_tags`
- `app.status_snapshots`
- `app.accounts`
- `app.ft_tokens`
- `app.nft_collections`
- `app.tx_metrics` (event_count, gas_used, fee, execution_status)
- `app.account_storage_snapshots` (optional cache)

## Workers (raw → app)
All workers are idempotent and checkpointed:
- `accounts_worker` → `app.accounts`
- `token_worker` → `app.token_transfers`
- `ft_holdings_worker` → `app.ft_holdings`
- `nft_ownership_worker` → `app.nft_ownership`
- `account_keys_worker` → `app.account_keys`
- `tx_contracts_worker` → `app.tx_contracts`
- `tx_tags_worker` → `app.tx_tags`
- `tx_metrics_worker` → `app.tx_metrics`

## API Layout
- `GET /api/v1/...` (find-api compatible)
- `GET /api/v2/...` (api.json compatible)
- `GET /openapi/v1.json`
- `GET /openapi/v2.json`
- `GET /docs/v1` (Scalar)
- `GET /docs/v2` (Scalar)

## Testing Strategy
### v1
- Golden fixtures from find-api responses (normalized fields).
- Unit tests per endpoint (table-driven).

### v2
- Schema-conformance tests against `api.json`.
- Invariants for critical fields (non-null, correct type).

## Full Rebuild Flow
1. Drop DB
2. Apply schema_v2
3. Reindex raw
4. Run workers (raw → app)
5. Run v1 + v2 tests

---

## Spec Coverage Matrix

```
Generated by: docs/tooling/generate_api_matrix.py
```

<!-- BEGIN GENERATED MATRIX -->
# API Coverage Matrix

- find-api paths: 97
- api.json paths: 74
- common paths: 74
- find-only paths: 23

## Tags (count by operations)

### find-api
- Flow: 38
- Staking: 15
- Accounting: 9
- Triggers: 8
- Status: 7
- Simple: 6
- DeFi: 5
- Wallet: 4
- NFT: 3
- Public: 3
- Auth: 1
- Bulk: 1

### api.json
- Flow: 38
- Staking: 15
- Accounting: 9
- Status: 7
- DeFi: 5

## Endpoint Matrix

| Path | Method | Tag | In v1 | In v2 | Response Schema (find) | Response Schema (api) |
|---|---|---|---|---|---|---|
| `/accounting/v1/account/{address}` | `GET` | Accounting | yes | yes | #/definitions/accounting.AccountDetailsResponse |  |
| `/accounting/v1/account/{address}/ft` | `GET` | Accounting | yes | yes | #/definitions/accounting.AccountFTCollectionsResponse |  |
| `/accounting/v1/account/{address}/ft/transfer` | `GET` | Accounting | yes | yes | #/definitions/accounting.TransfersResponse |  |
| `/accounting/v1/account/{address}/nft` | `GET` | Accounting | yes | yes | #/definitions/accounting.AccountNFTCollectionsResponse |  |
| `/accounting/v1/account/{address}/tax-report` | `GET` | Accounting | yes | yes | #/definitions/accounting.TaxReportResponse |  |
| `/accounting/v1/account/{address}/transaction` | `GET` | Accounting | yes | yes | #/definitions/accounting.AccountTransactionsResponse |  |
| `/accounting/v1/nft/transfer` | `GET` | Accounting | yes | yes | #/definitions/accounting.NFTTransfersResponse |  |
| `/accounting/v1/transaction` | `GET` | Accounting | yes | yes | #/definitions/accounting.TransactionsResponse |  |
| `/accounting/v1/transaction/{id}` | `GET` | Accounting | yes | yes | #/definitions/accounting.TransactionResponse |  |
| `/auth/v1/generate` | `POST` | Auth | yes | no | #/definitions/auth.TokenResponse |  |
| `/bulk/v1/contract` | `GET` | Bulk | yes | no |  |  |
| `/defi/v1/asset` | `GET` | DeFi | yes | yes |  |  |
| `/defi/v1/events` | `GET` | DeFi | yes | yes |  |  |
| `/defi/v1/latest-block` | `GET` | DeFi | yes | yes |  |  |
| `/defi/v1/latest-swap` | `GET` | DeFi | yes | yes |  |  |
| `/defi/v1/pair` | `GET` | DeFi | yes | yes | #/definitions/defi.Pair |  |
| `/flow/v1/account` | `GET` | Flow | yes | yes | #/definitions/flow.AccountsResponse |  |
| `/flow/v1/account/{address}` | `GET` | Flow | yes | yes | #/definitions/flow.AccountDetailsResponse |  |
| `/flow/v1/account/{address}/ft` | `GET` | Flow | yes | yes | #/definitions/flow.AccountFTCollectionsResponse |  |
| `/flow/v1/account/{address}/ft/holding` | `GET` | Flow | yes | yes | #/definitions/flow.FTHoldingResponse |  |
| `/flow/v1/account/{address}/ft/transfer` | `GET` | Flow | yes | yes | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/account/{address}/ft/{token}` | `GET` | Flow | yes | yes | #/definitions/flow.AccountFungibleTokenResponse |  |
| `/flow/v1/account/{address}/ft/{token}/transfer` | `GET` | Flow | yes | yes | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/account/{address}/nft` | `GET` | Flow | yes | yes | #/definitions/flow.AccountNFTCollectionsResponse |  |
| `/flow/v1/account/{address}/nft/{nft_type}` | `GET` | Flow | yes | yes | #/definitions/flow.AccountNFTResponse |  |
| `/flow/v1/account/{address}/tax-report` | `GET` | Flow | yes | yes | #/definitions/flow.TaxReportResponse |  |
| `/flow/v1/account/{address}/transaction` | `GET` | Flow | yes | yes | #/definitions/flow.AccountTransactionsResponse |  |
| `/flow/v1/block` | `GET` | Flow | yes | yes | #/definitions/flow.BlockResponse |  |
| `/flow/v1/block/{height}` | `GET` | Flow | yes | yes | #/definitions/flow.BlockResponse |  |
| `/flow/v1/block/{height}/service-event` | `GET` | Flow | yes | yes | #/definitions/flow.BlockServiceEventResponse |  |
| `/flow/v1/block/{height}/transaction` | `GET` | Flow | yes | yes | #/definitions/flow.BlockTransactionsResponse |  |
| `/flow/v1/contract` | `GET` | Flow | yes | yes | #/definitions/flow.ContractResponse |  |
| `/flow/v1/contract/{identifier}` | `GET` | Flow | yes | yes | #/definitions/flow.ContractResponse |  |
| `/flow/v1/contract/{identifier}/{id}` | `GET` | Flow | yes | yes | #/definitions/flow.ContractResponse |  |
| `/flow/v1/evm/token` | `GET` | Flow | yes | yes | #/definitions/flow.EvmTokenResponse |  |
| `/flow/v1/evm/token/{address}` | `GET` | Flow | yes | yes | #/definitions/flow.EvmTokenResponse |  |
| `/flow/v1/evm/transaction` | `GET` | Flow | yes | yes | #/definitions/flow.EvmTransactionResponse |  |
| `/flow/v1/evm/transaction/{hash}` | `GET` | Flow | yes | yes | #/definitions/flow.EvmTransactionOutput |  |
| `/flow/v1/ft` | `GET` | Flow | yes | yes | #/definitions/flow.FTListResponse |  |
| `/flow/v1/ft/transfer` | `GET` | Flow | yes | yes | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/ft/{token}` | `GET` | Flow | yes | yes | #/definitions/flow.FungibleTokenResponse |  |
| `/flow/v1/ft/{token}/account/{address}` | `GET` | Flow | yes | yes | #/definitions/flow.AccountFungibleTokenResponse |  |
| `/flow/v1/ft/{token}/holding` | `GET` | Flow | yes | yes | #/definitions/flow.FTHoldingResponse |  |
| `/flow/v1/nft` | `GET` | Flow | yes | yes | #/definitions/flow.NFTCollectionResponse |  |
| `/flow/v1/nft/transfer` | `GET` | Flow | yes | yes | #/definitions/flow.NFTTransfersResponse |  |
| `/flow/v1/nft/{nft_type}` | `GET` | Flow | yes | yes | #/definitions/flow.NFTCollectionDetailsResponse |  |
| `/flow/v1/nft/{nft_type}/holding` | `GET` | Flow | yes | yes | #/definitions/flow.NFTHoldingResponse |  |
| `/flow/v1/nft/{nft_type}/item/{id}` | `GET` | Flow | yes | yes | #/definitions/flow.NFTDetailsResponse |  |
| `/flow/v1/node` | `GET` | Flow | yes | yes | #/definitions/flow.NodesResponse |  |
| `/flow/v1/node/{node_id}` | `GET` | Flow | yes | yes | #/definitions/flow.NodeResponse |  |
| `/flow/v1/node/{node_id}/reward/delegation` | `GET` | Flow | yes | yes | #/definitions/flow.DelegationRewardResponse |  |
| `/flow/v1/scheduled-transaction` | `GET` | Flow | yes | yes | #/definitions/flow.ScheduledTransactionsListResponse |  |
| `/flow/v1/transaction` | `GET` | Flow | yes | yes | #/definitions/flow.TransactionsResponse |  |
| `/flow/v1/transaction/{id}` | `GET` | Flow | yes | yes | #/definitions/flow.TransactionResponse |  |
| `/nft/v0/{nft_type}/holding` | `GET` | NFT | yes | no | #/definitions/nft.NFTHoldingResponse |  |
| `/nft/v0/{nft_type}/item` | `GET` | NFT | yes | no | #/definitions/nft.NFTItemsResponse |  |
| `/nft/v0/{nft_type}/item/{nft_id}` | `GET` | NFT | yes | no | #/definitions/nft.NFTItemsResponse |  |
| `/public/v1/account/{address}` | `GET` | Public | yes | no | #/definitions/public.AccountDetailsResponse |  |
| `/public/v1/epoch/payout` | `GET` | Public | yes | no | #/definitions/public.EpochPayoutResponse |  |
| `/public/v1/resolver` | `GET` | Public | yes | no | #/definitions/public.ResolverResponse |  |
| `/simple/v1/blocks` | `GET` | Simple | yes | no | #/definitions/simple.BlocksResponse |  |
| `/simple/v1/events` | `GET` | Simple | yes | no | #/definitions/simple.EventsResponse |  |
| `/simple/v1/node_rewards` | `GET` | Simple | yes | no | #/definitions/simple.NodeRewardsResponse |  |
| `/simple/v1/rewards` | `GET` | Simple | yes | no | #/definitions/simple.DelegationRewardsResponse |  |
| `/simple/v1/transaction` | `GET` | Simple | yes | no | #/definitions/simple.TransactionsResponse |  |
| `/simple/v1/transaction/events` | `GET` | Simple | yes | no | #/definitions/simple.TransactionEventsResponse |  |
| `/staking/v1/account/{address}/ft/transfer` | `GET` | Staking | yes | yes | #/definitions/staking.TransfersResponse |  |
| `/staking/v1/account/{address}/transaction` | `GET` | Staking | yes | yes | #/definitions/flow.AccountTransactionsResponse |  |
| `/staking/v1/delegator` | `GET` | Staking | yes | yes | #/definitions/staking.DelegatorResponse |  |
| `/staking/v1/epoch/stats` | `GET` | Staking | yes | yes | #/definitions/staking.StatsEpochResponse |  |
| `/staking/v1/epoch/{epoch}/nodes` | `GET` | Staking | yes | yes | #/definitions/staking.EpochNodesResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/aggregate` | `GET` | Staking | yes | yes | #/definitions/staking.EpochNodesAggregateResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/count` | `GET` | Staking | yes | yes | #/definitions/staking.EpochNodesCountResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/grouped` | `GET` | Staking | yes | yes | #/definitions/staking.EpochNodesGroupedResponse |  |
| `/staking/v1/ft_transfer/{address}` | `GET` | Staking | yes | yes | #/definitions/staking.FTTransferResponse |  |
| `/staking/v1/node/{node_id}/event` | `GET` | Staking | yes | yes | #/definitions/staking.EventsResponse |  |
| `/staking/v1/rewards/paid` | `GET` | Staking | yes | yes | #/definitions/staking.RewardsPaidResponse |  |
| `/staking/v1/rewards/staking` | `GET` | Staking | yes | yes | #/definitions/staking.RewardsStakingResponse |  |
| `/staking/v1/tokenomics` | `GET` | Staking | yes | yes | #/definitions/staking.TokenomicsResponse |  |
| `/staking/v1/transaction/address/{address}` | `GET` | Staking | yes | yes | #/definitions/staking.TransactionResponse |  |
| `/staking/v1/transaction/{transaction_id}` | `GET` | Staking | yes | yes | #/definitions/staking.TransactionEventResponse |  |
| `/status/v1/count` | `GET` | Status | yes | yes | #/definitions/status.CountsResponse |  |
| `/status/v1/epoch/stat` | `GET` | Status | yes | yes | #/definitions/status.EpochStatsResponse |  |
| `/status/v1/epoch/status` | `GET` | Status | yes | yes | #/definitions/status.EpochStatusResponse |  |
| `/status/v1/flow/stat` | `GET` | Status | yes | yes | #/definitions/status.FlowStatsResponse |  |
| `/status/v1/stat` | `GET` | Status | yes | yes | #/definitions/status.StatsResponse |  |
| `/status/v1/stat/{timescale}/trend` | `GET` | Status | yes | yes | #/definitions/status.StatsTrendResponse |  |
| `/status/v1/tokenomics` | `GET` | Status | yes | yes | #/definitions/status.TokenomicsResponse |  |
| `/triggers/v1/logs` | `GET` | Triggers | yes | no | #/definitions/triggers.TriggerLogsResponse |  |
| `/triggers/v1/requeue/{id}` | `POST` | Triggers | yes | no | #/definitions/triggers.RequeueResponse |  |
| `/triggers/v1/triggers` | `GET` | Triggers | yes | no | #/definitions/triggers.ListTriggersResponse |  |
| `/triggers/v1/triggers` | `POST` | Triggers | yes | no |  |  |
| `/triggers/v1/triggers/{id}` | `DELETE` | Triggers | yes | no |  |  |
| `/triggers/v1/triggers/{id}` | `GET` | Triggers | yes | no | #/definitions/triggers.GetTriggerByIDResponse |  |
| `/triggers/v1/triggers/{id}` | `PUT` | Triggers | yes | no | #/definitions/triggers.Trigger |  |
| `/triggers/v1/triggers/{id}/status` | `PATCH` | Triggers | yes | no | #/definitions/triggers.Trigger |  |
| `/wallet/v1/participation/{address}` | `GET` | Wallet | yes | no | #/definitions/wallet.ParticipationTokenResponse |  |
| `/wallet/v1/participation/{address}/aggregate` | `GET` | Wallet | yes | no | #/definitions/wallet.ParticipationTokenResponse |  |
| `/wallet/v1/participation/{address}/count` | `GET` | Wallet | yes | no | #/definitions/wallet.ParticipationCountResponse |  |
| `/wallet/v1/participation/{address}/{token}` | `GET` | Wallet | yes | no | #/definitions/wallet.ParticipationTokenResponse |  |

## Schema Diff Summary

This section lists response schema names that differ between v1 and v2 on shared paths.

| Path | Method | find schema | api schema |
|---|---|---|---|
| `/accounting/v1/account/{address}` | `GET` | #/definitions/accounting.AccountDetailsResponse |  |
| `/accounting/v1/account/{address}/ft` | `GET` | #/definitions/accounting.AccountFTCollectionsResponse |  |
| `/accounting/v1/account/{address}/ft/transfer` | `GET` | #/definitions/accounting.TransfersResponse |  |
| `/accounting/v1/account/{address}/nft` | `GET` | #/definitions/accounting.AccountNFTCollectionsResponse |  |
| `/accounting/v1/account/{address}/tax-report` | `GET` | #/definitions/accounting.TaxReportResponse |  |
| `/accounting/v1/account/{address}/transaction` | `GET` | #/definitions/accounting.AccountTransactionsResponse |  |
| `/accounting/v1/nft/transfer` | `GET` | #/definitions/accounting.NFTTransfersResponse |  |
| `/accounting/v1/transaction` | `GET` | #/definitions/accounting.TransactionsResponse |  |
| `/accounting/v1/transaction/{id}` | `GET` | #/definitions/accounting.TransactionResponse |  |
| `/defi/v1/pair` | `GET` | #/definitions/defi.Pair |  |
| `/flow/v1/account` | `GET` | #/definitions/flow.AccountsResponse |  |
| `/flow/v1/account/{address}` | `GET` | #/definitions/flow.AccountDetailsResponse |  |
| `/flow/v1/account/{address}/ft` | `GET` | #/definitions/flow.AccountFTCollectionsResponse |  |
| `/flow/v1/account/{address}/ft/holding` | `GET` | #/definitions/flow.FTHoldingResponse |  |
| `/flow/v1/account/{address}/ft/transfer` | `GET` | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/account/{address}/ft/{token}` | `GET` | #/definitions/flow.AccountFungibleTokenResponse |  |
| `/flow/v1/account/{address}/ft/{token}/transfer` | `GET` | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/account/{address}/nft` | `GET` | #/definitions/flow.AccountNFTCollectionsResponse |  |
| `/flow/v1/account/{address}/nft/{nft_type}` | `GET` | #/definitions/flow.AccountNFTResponse |  |
| `/flow/v1/account/{address}/tax-report` | `GET` | #/definitions/flow.TaxReportResponse |  |
| `/flow/v1/account/{address}/transaction` | `GET` | #/definitions/flow.AccountTransactionsResponse |  |
| `/flow/v1/block` | `GET` | #/definitions/flow.BlockResponse |  |
| `/flow/v1/block/{height}` | `GET` | #/definitions/flow.BlockResponse |  |
| `/flow/v1/block/{height}/service-event` | `GET` | #/definitions/flow.BlockServiceEventResponse |  |
| `/flow/v1/block/{height}/transaction` | `GET` | #/definitions/flow.BlockTransactionsResponse |  |
| `/flow/v1/contract` | `GET` | #/definitions/flow.ContractResponse |  |
| `/flow/v1/contract/{identifier}` | `GET` | #/definitions/flow.ContractResponse |  |
| `/flow/v1/contract/{identifier}/{id}` | `GET` | #/definitions/flow.ContractResponse |  |
| `/flow/v1/evm/token` | `GET` | #/definitions/flow.EvmTokenResponse |  |
| `/flow/v1/evm/token/{address}` | `GET` | #/definitions/flow.EvmTokenResponse |  |
| `/flow/v1/evm/transaction` | `GET` | #/definitions/flow.EvmTransactionResponse |  |
| `/flow/v1/evm/transaction/{hash}` | `GET` | #/definitions/flow.EvmTransactionOutput |  |
| `/flow/v1/ft` | `GET` | #/definitions/flow.FTListResponse |  |
| `/flow/v1/ft/transfer` | `GET` | #/definitions/flow.TransfersResponse |  |
| `/flow/v1/ft/{token}` | `GET` | #/definitions/flow.FungibleTokenResponse |  |
| `/flow/v1/ft/{token}/account/{address}` | `GET` | #/definitions/flow.AccountFungibleTokenResponse |  |
| `/flow/v1/ft/{token}/holding` | `GET` | #/definitions/flow.FTHoldingResponse |  |
| `/flow/v1/nft` | `GET` | #/definitions/flow.NFTCollectionResponse |  |
| `/flow/v1/nft/transfer` | `GET` | #/definitions/flow.NFTTransfersResponse |  |
| `/flow/v1/nft/{nft_type}` | `GET` | #/definitions/flow.NFTCollectionDetailsResponse |  |
| `/flow/v1/nft/{nft_type}/holding` | `GET` | #/definitions/flow.NFTHoldingResponse |  |
| `/flow/v1/nft/{nft_type}/item/{id}` | `GET` | #/definitions/flow.NFTDetailsResponse |  |
| `/flow/v1/node` | `GET` | #/definitions/flow.NodesResponse |  |
| `/flow/v1/node/{node_id}` | `GET` | #/definitions/flow.NodeResponse |  |
| `/flow/v1/node/{node_id}/reward/delegation` | `GET` | #/definitions/flow.DelegationRewardResponse |  |
| `/flow/v1/scheduled-transaction` | `GET` | #/definitions/flow.ScheduledTransactionsListResponse |  |
| `/flow/v1/transaction` | `GET` | #/definitions/flow.TransactionsResponse |  |
| `/flow/v1/transaction/{id}` | `GET` | #/definitions/flow.TransactionResponse |  |
| `/staking/v1/account/{address}/ft/transfer` | `GET` | #/definitions/staking.TransfersResponse |  |
| `/staking/v1/account/{address}/transaction` | `GET` | #/definitions/flow.AccountTransactionsResponse |  |
| `/staking/v1/delegator` | `GET` | #/definitions/staking.DelegatorResponse |  |
| `/staking/v1/epoch/stats` | `GET` | #/definitions/staking.StatsEpochResponse |  |
| `/staking/v1/epoch/{epoch}/nodes` | `GET` | #/definitions/staking.EpochNodesResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/aggregate` | `GET` | #/definitions/staking.EpochNodesAggregateResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/count` | `GET` | #/definitions/staking.EpochNodesCountResponse |  |
| `/staking/v1/epoch/{epoch}/role/{role}/nodes/grouped` | `GET` | #/definitions/staking.EpochNodesGroupedResponse |  |
| `/staking/v1/ft_transfer/{address}` | `GET` | #/definitions/staking.FTTransferResponse |  |
| `/staking/v1/node/{node_id}/event` | `GET` | #/definitions/staking.EventsResponse |  |
| `/staking/v1/rewards/paid` | `GET` | #/definitions/staking.RewardsPaidResponse |  |
| `/staking/v1/rewards/staking` | `GET` | #/definitions/staking.RewardsStakingResponse |  |
| `/staking/v1/tokenomics` | `GET` | #/definitions/staking.TokenomicsResponse |  |
| `/staking/v1/transaction/address/{address}` | `GET` | #/definitions/staking.TransactionResponse |  |
| `/staking/v1/transaction/{transaction_id}` | `GET` | #/definitions/staking.TransactionEventResponse |  |
| `/status/v1/count` | `GET` | #/definitions/status.CountsResponse |  |
| `/status/v1/epoch/stat` | `GET` | #/definitions/status.EpochStatsResponse |  |
| `/status/v1/epoch/status` | `GET` | #/definitions/status.EpochStatusResponse |  |
| `/status/v1/flow/stat` | `GET` | #/definitions/status.FlowStatsResponse |  |
| `/status/v1/stat` | `GET` | #/definitions/status.StatsResponse |  |
| `/status/v1/stat/{timescale}/trend` | `GET` | #/definitions/status.StatsTrendResponse |  |
| `/status/v1/tokenomics` | `GET` | #/definitions/status.TokenomicsResponse |  |
<!-- END GENERATED MATRIX -->
