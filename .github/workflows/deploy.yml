name: Deploy to GCP

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      services:
        description: "Services to deploy (comma-separated: backend,frontend,docs,ai-chat,studio or 'all')"
        required: false
        default: "all"
        type: string

env:
  PROJECT_ID: flowindex-mainnet
  REGION: us-central1
  REGISTRY: us-central1-docker.pkg.dev/flowindex-mainnet/flowindex

jobs:
  # Detect which services changed (or use manual input)
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.result.outputs.backend }}
      frontend: ${{ steps.result.outputs.frontend }}
      docs: ${{ steps.result.outputs.docs }}
      ai-chat: ${{ steps.result.outputs.ai-chat }}
      studio: ${{ steps.result.outputs.studio }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        if: github.event_name == 'push'
        with:
          filters: |
            backend:
              - 'backend/**'
              - 'openapi-v1.json'
              - 'openapi-v2.json'
              - '.github/workflows/deploy.yml'
            frontend:
              - 'frontend/**'
              - '.github/workflows/deploy.yml'
            docs:
              - 'devportal/**'
              - 'docs/**'
            ai-chat:
              - 'ai/chat/**'
              - '.github/workflows/deploy.yml'
            studio:
              - 'studio/**'
              - '.github/workflows/deploy.yml'
      - name: Resolve outputs
        id: result
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SERVICES="${{ inputs.services }}"
            if [ "$SERVICES" = "all" ] || [ -z "$SERVICES" ]; then
              echo "backend=true" >> $GITHUB_OUTPUT
              echo "frontend=true" >> $GITHUB_OUTPUT
              echo "docs=true" >> $GITHUB_OUTPUT
              echo "ai-chat=true" >> $GITHUB_OUTPUT
              echo "studio=true" >> $GITHUB_OUTPUT
            else
              echo "backend=false" >> $GITHUB_OUTPUT
              echo "frontend=false" >> $GITHUB_OUTPUT
              echo "docs=false" >> $GITHUB_OUTPUT
              echo "ai-chat=false" >> $GITHUB_OUTPUT
              echo "studio=false" >> $GITHUB_OUTPUT
              IFS=',' read -ra PARTS <<< "$SERVICES"
              for svc in "${PARTS[@]}"; do
                svc=$(echo "$svc" | xargs)
                echo "${svc}=true" >> $GITHUB_OUTPUT
              done
            fi
          else
            echo "backend=${{ steps.filter.outputs.backend }}" >> $GITHUB_OUTPUT
            echo "frontend=${{ steps.filter.outputs.frontend }}" >> $GITHUB_OUTPUT
            echo "docs=${{ steps.filter.outputs.docs }}" >> $GITHUB_OUTPUT
            echo "ai-chat=${{ steps.filter.outputs.ai-chat }}" >> $GITHUB_OUTPUT
            echo "studio=${{ steps.filter.outputs.studio }}" >> $GITHUB_OUTPUT
          fi

  build-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    concurrency:
      group: deploy-backend-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push backend
        run: |
          docker build -f backend/Dockerfile \
            --build-arg GIT_COMMIT=${{ github.sha }} \
            -t ${{ env.REGISTRY }}/backend:latest \
            -t ${{ env.REGISTRY }}/backend:${{ github.sha }} \
            .
          docker push ${{ env.REGISTRY }}/backend --all-tags

      - name: Deploy backend (zero-downtime)
        run: |
          gcloud compute ssh flowindex-backend --zone=us-central1-a --command='
            IMAGE=${{ env.REGISTRY }}/backend:${{ github.sha }}
            docker-credential-gcr configure-docker --registries=us-central1-docker.pkg.dev 2>/dev/null || true
            docker pull $IMAGE
            docker stop backend 2>/dev/null; docker rm backend 2>/dev/null
            docker run --rm --network=host \
              --env-file /mnt/stateful_partition/pgdata/backend.env \
              $IMAGE ./indexer migrate --terminate-conns
            docker run -d --restart=always --name backend \
              --network=host \
              --env-file /mnt/stateful_partition/pgdata/backend.env \
              -e SKIP_MIGRATION=true \
              $IMAGE
          '

  build-frontend:
    needs: [changes, build-backend]
    if: |
      always() &&
      needs.changes.outputs.frontend == 'true' &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped')
    concurrency:
      group: deploy-frontend-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push frontend
        run: |
          docker build -f frontend/Dockerfile \
            --build-arg VITE_API_URL=/api \
            --build-arg VITE_GOTRUE_URL=/auth \
            --build-arg VITE_GIT_COMMIT=${{ github.sha }} \
            -t ${{ env.REGISTRY }}/frontend:latest \
            -t ${{ env.REGISTRY }}/frontend:${{ github.sha }} \
            .
          docker push ${{ env.REGISTRY }}/frontend --all-tags

      - name: Deploy frontend (pull & restart on GCE)
        run: |
          gcloud compute ssh flowindex-frontend --zone=us-central1-a --command='
            docker-credential-gcr configure-docker --registries=us-central1-docker.pkg.dev 2>/dev/null || true; \
            docker pull ${{ env.REGISTRY }}/frontend:${{ github.sha }} && \
            docker stop frontend 2>/dev/null; docker rm frontend 2>/dev/null; \
            docker run -d --restart=always --name frontend \
              --network=host \
              -e BACKEND_API=http://10.128.0.4:8080 \
              -e BACKEND_WS=http://10.128.0.4:8080 \
              -e GOTRUE_URL=http://10.128.0.4:9999 \
              -e STUDIO_AUTH_URL=http://10.128.0.4:8000 \
              -e VITE_API_URL=https://flowindex.io/api \
              ${{ env.REGISTRY }}/frontend:${{ github.sha }}
          '

      - name: Update Caddy config for TLS
        run: |
          gcloud compute ssh flowindex-frontend --zone=us-central1-a --command="
            sudo tee /tmp/Caddyfile > /dev/null <<'CADDYEOF'
          $(cat frontend/Caddyfile)
          CADDYEOF
            docker exec caddy caddy reload --config /etc/caddy/Caddyfile --adapter caddyfile
          "

  build-docs:
    needs: changes
    if: needs.changes.outputs.docs == 'true'
    concurrency:
      group: deploy-docs-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push docs
        run: |
          docker build -f devportal/Dockerfile \
            -t ${{ env.REGISTRY }}/docs:latest \
            -t ${{ env.REGISTRY }}/docs:${{ github.sha }} \
            .
          docker push ${{ env.REGISTRY }}/docs --all-tags

      - name: Deploy docs to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: flowindex-docs
          region: us-central1
          image: ${{ env.REGISTRY }}/docs:${{ github.sha }}

  build-ai-chat:
    needs: changes
    if: needs.changes.outputs.ai-chat == 'true'
    concurrency:
      group: deploy-ai-chat-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push ai-chat
        run: |
          docker build -f ai/chat/Dockerfile \
            -t ${{ env.REGISTRY }}/ai-chat:latest \
            -t ${{ env.REGISTRY }}/ai-chat:${{ github.sha }} \
            ai/chat
          docker push ${{ env.REGISTRY }}/ai-chat --all-tags

      - name: Deploy ai-chat (pull & restart on GCE)
        run: |
          gcloud compute ssh flowindex-backend --zone=us-central1-a --command='
            docker-credential-gcr configure-docker --registries=us-central1-docker.pkg.dev 2>/dev/null || true; \
            docker pull ${{ env.REGISTRY }}/ai-chat:${{ github.sha }} && \
            docker stop ai-chat 2>/dev/null; docker rm ai-chat 2>/dev/null; \
            docker run -d --restart=always --name ai-chat \
              --network=host \
              --env-file /mnt/stateful_partition/pgdata/ai-chat.env \
              ${{ env.REGISTRY }}/ai-chat:${{ github.sha }}
          '

  build-studio:
    needs: changes
    if: needs.changes.outputs.studio == 'true'
    concurrency:
      group: deploy-studio-${{ github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker us-central1-docker.pkg.dev --quiet

      - name: Build & push studio
        run: |
          docker build -f studio/Dockerfile \
            -t ${{ env.REGISTRY }}/studio:latest \
            -t ${{ env.REGISTRY }}/studio:${{ github.sha }} \
            studio
          docker push ${{ env.REGISTRY }}/studio --all-tags

      - name: Create deploy script
        run: |
          cat > /tmp/deploy-studio.sh << 'SCRIPT'
          #!/bin/bash
          set -e
          REGISTRY_IMAGE="$1"

          # Load env files safely (handles values with backticks/special chars)
          load_env() {
            while IFS= read -r line || [ -n "$line" ]; do
              # Skip comments and blank lines
              [[ "$line" =~ ^[[:space:]]*# ]] && continue
              [[ -z "$line" ]] && continue
              # Export the variable
              export "$line" 2>/dev/null || true
            done < "$1"
          }

          load_env /mnt/stateful_partition/pgdata/backend.env

          # Auto-create studio.env with defaults if it does not exist
          STUDIO_ENV=/mnt/stateful_partition/pgdata/studio.env
          if [ ! -f "$STUDIO_ENV" ]; then
            GENERATED_PW=$(head -c 16 /dev/urandom | base64 | tr -d "/+=" | head -c 20)
            printf "STUDIO_USER=admin\nSTUDIO_PASSWORD=%s\n" "$GENERATED_PW" > "$STUDIO_ENV"
            echo "Created $STUDIO_ENV with generated password: $GENERATED_PW"
          fi
          load_env "$STUDIO_ENV"

          # Parse DB credentials from SUPABASE_DB_URL (postgres://user:pass@host:port/dbname)
          DB_USER=$(echo "$SUPABASE_DB_URL" | sed -n 's|postgres://\([^:]*\):.*|\1|p')
          DB_PASS=$(echo "$SUPABASE_DB_URL" | sed -n 's|postgres://[^:]*:\([^@]*\)@.*|\1|p')
          DB_HOST=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*@\([^:/]*\)[:/].*|\1|p')
          DB_PORT=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*:\([0-9]*\)/.*|\1|p')
          DB_NAME=$(echo "$SUPABASE_DB_URL" | sed -n 's|.*/\([^?]*\).*|\1|p')

          echo "DB: $DB_USER@$DB_HOST:$DB_PORT/$DB_NAME"

          # 1) pg-meta (port 8085)
          docker stop supabase-meta 2>/dev/null || true; docker rm supabase-meta 2>/dev/null || true
          docker run -d --restart=always --name supabase-meta \
            --network=host \
            -e PG_META_PORT=8085 \
            -e PG_META_DB_HOST="$DB_HOST" \
            -e PG_META_DB_PORT="$DB_PORT" \
            -e PG_META_DB_NAME="$DB_NAME" \
            -e PG_META_DB_USER="$DB_USER" \
            -e PG_META_DB_PASSWORD="$DB_PASS" \
            supabase/postgres-meta:v0.84.2

          # 2) Studio (port 3100)
          docker stop supabase-studio 2>/dev/null || true; docker rm supabase-studio 2>/dev/null || true
          docker run -d --restart=always --name supabase-studio \
            --network=host \
            -e PORT=3100 \
            -e HOSTNAME=0.0.0.0 \
            -e STUDIO_PG_META_URL=http://127.0.0.1:8085 \
            -e SUPABASE_URL=http://127.0.0.1:9999 \
            -e SUPABASE_REST_URL=http://127.0.0.1:9999 \
            -e SUPABASE_ANON_KEY="${SUPABASE_ANON_KEY:-anon}" \
            -e SUPABASE_SERVICE_KEY="${SUPABASE_SERVICE_KEY:-service}" \
            -e NEXT_PUBLIC_ENABLE_LOGS=true \
            -e NEXT_ANALYTICS_BACKEND_PROVIDER= \
            supabase/studio:latest

          # 3) studio-auth (port 8000)
          docker stop studio-auth 2>/dev/null || true; docker rm studio-auth 2>/dev/null || true
          docker run -d --restart=always --name studio-auth \
            --network=host \
            -e STUDIO_USER="${STUDIO_USER:-admin}" \
            -e STUDIO_PASSWORD="${STUDIO_PASSWORD:-changeme}" \
            -e STUDIO_UPSTREAM=http://127.0.0.1:3100 \
            "$REGISTRY_IMAGE"

          echo "Studio stack deployed successfully"
          docker ps --filter name=supabase --filter name=studio --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
          SCRIPT

      - name: Deploy studio stack (pg-meta + studio + studio-auth on GCE)
        run: |
          gcloud compute ssh flowindex-backend --zone=us-central1-a --command='
            docker-credential-gcr configure-docker --registries=us-central1-docker.pkg.dev 2>/dev/null || true
            echo "=== Disk usage before prune ==="
            df -h / /var/lib/docker 2>/dev/null || df -h /
            docker system prune -af 2>/dev/null || true
            echo "=== Disk usage after prune ==="
            df -h / /var/lib/docker 2>/dev/null || df -h /
            docker pull ${{ env.REGISTRY }}/studio:${{ github.sha }}
            docker pull supabase/postgres-meta:v0.84.2
            docker pull supabase/studio:latest
          '
          gcloud compute scp /tmp/deploy-studio.sh flowindex-backend:/tmp/deploy-studio.sh --zone=us-central1-a
          gcloud compute ssh flowindex-backend --zone=us-central1-a --command='
            bash /tmp/deploy-studio.sh ${{ env.REGISTRY }}/studio:${{ github.sha }}
          '
