server {
    listen 8000;

    # Login page (no auth required)
    location = /studio-login {
        default_type text/html;
        alias /etc/nginx/login.html;
    }

    # Login submit â€” validate token and set session cookie
    location = /studio-login-submit {
        default_type text/html;

        if ($arg_token = "${STUDIO_SESSION_TOKEN}") {
            add_header Set-Cookie "studio_session=${STUDIO_SESSION_TOKEN}; Path=/; HttpOnly; SameSite=Lax; Max-Age=604800" always;
            return 302 /;
        }
        return 302 /studio-login?error=1;
    }

    # All other requests require valid session cookie
    location / {
        # Check session cookie
        if ($cookie_studio_session != "${STUDIO_SESSION_TOKEN}") {
            return 302 /studio-login;
        }

        proxy_pass ${STUDIO_UPSTREAM};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
