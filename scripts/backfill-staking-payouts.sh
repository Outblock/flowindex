#!/usr/bin/env bash
# Backfill EpochTotalRewardsPaid data for all known payout blocks.
# Run AFTER deploying the new code (which adds payout columns + admin endpoint).
#
# Usage:
#   ADMIN_TOKEN='your-token' ./scripts/backfill-staking-payouts.sh
#   ADMIN_TOKEN='your-token' API_URL='http://34.170.76.156:8080' ./scripts/backfill-staking-payouts.sh

set -euo pipefail

API_URL="${API_URL:-http://34.170.76.156:8080}"

if [ -z "${ADMIN_TOKEN:-}" ]; then
  echo "ERROR: ADMIN_TOKEN is required"
  exit 1
fi

echo "=== Backfilling staking payout data ==="
echo "API: $API_URL"

# All 232 payout block heights (epoch 219 â†’ earliest), sourced from find.xyz
curl -s -X POST "$API_URL/admin/backfill-staking" \
  -H "Authorization: Bearer $ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
  "heights": [
    142651980,141896604,141140891,140385434,139629698,138874678,138125647,137602229,
    137091524,136335769,135580010,134824326,134068532,133312715,132557219,131801391,
    131045660,130294888,129563459,128809151,128053851,127307804,126569035,125833339,
    125092371,124339522,123592240,122838024,122084288,121348445,120606593,119861178,
    119106401,118351627,117597239,116844577,116090202,115335948,114581291,113826205,
    113071119,112315946,111560370,110804758,110049274,109293632,108537963,107785703,
    107029891,106332969,105578828,104827006,104076001,103322898,102568445,101814057,
    101059652,100305038,99550298,98795710,98041752,97286705,96531629,95776337,
    95020936,94266146,93510819,92755508,92000103,91246384,90490857,89735288,
    88979514,88226844,87488569,86733264,85990496,85518687,85035782,84552949,
    84070381,83587437,83104603,82623139,82142357,81660542,81177941,80695269,
    80213649,79732107,79250037,78768036,78286155,77803947,77321894,76839702,
    76357487,75875265,75392816,74910477,
    74428072,73945653,73463477,72980870,72498374,72015762,71533264,71050516,
    70567697,70084821,69602068,69119184,68636287,68153393,67670495,67187677,
    66706340,66225546,65746713,65326683,64581253,63913536,63234180,62745584,
    62325547,61844923,61363813,60882714,60401347,59919663,59438128,58957961,
    58481756,58000709,57519637,57038623,56557835,56078122,55596474,55179362,
    54646791,54164415,53682516,53200183,52717944,52235978,51753836,51286377,
    50797468,50308221,49822846,49379498,48931884,48483645,48038844,47601233,
    47169429,46720088,46272125,45830944,45385771,44949090,44519103,44081918,
    43645961,43214638,42779272,42333801,41881384,41443995,41011365,40592123,
    40171177,39753457,39332732,38905995,38471117,38028791,37588023,37155081,
    36728407,36289874,35853746,35449898,35014760,34581422,34149441,33718312,
    33285965,32856076,32408104,31997638,31735693,31305219,30872827,30440288,
    30001058,29554494,29106647,28649943,
    28202774,27764834,27341246,26926232,26488403,26022885,25568454,25115301,
    24671744,24225469,23830246,23545156,23256231,22976647,22692277,22406366,
    22118310,21830880,21534607,21256333,20991276,20731158,20466622,20201378,
    19939094,19683671,19420984,19220467,19022340,18876169,18735225,18550689
  ]
}' | python3 -m json.tool

echo ""
echo "=== Verifying: fetching first 5 payouts ==="
curl -s "$API_URL/public/v1/epoch/payout?limit=5" | python3 -m json.tool

echo ""
echo "=== Cross-validation against find.xyz ==="
echo "find.xyz epoch 219:"
curl -s "https://api.find.xyz/public/v1/epoch/payout?limit=1" | python3 -m json.tool
echo ""
echo "Our epoch 219:"
curl -s "$API_URL/public/v1/epoch/payout?limit=1" | python3 -m json.tool
